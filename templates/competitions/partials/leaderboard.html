<!-- HTMX partial: Leaderboard with charts -->
{% if leaderboard %}

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Score Trend Chart -->
    <div class="bg-base-200 rounded-box p-4">
        <h3 class="font-semibold mb-3 flex items-center gap-2">
            <i data-lucide="trending-up" class="w-4 h-4 text-primary"></i> Score Trend
        </h3>
        <div class="h-64">
            <canvas id="trendChart"></canvas>
        </div>
    </div>

    <!-- Score Distribution Chart -->
    <div class="bg-base-200 rounded-box p-4">
        <h3 class="font-semibold mb-3 flex items-center gap-2">
            <i data-lucide="bar-chart-2" class="w-4 h-4 text-secondary"></i> Score Distribution
        </h3>
        <div class="h-64">
            <canvas id="distributionChart"></canvas>
        </div>
    </div>
</div>

<!-- Leaderboard Table -->
<div class="overflow-x-auto">
    <table class="table">
        <thead>
            <tr>
                <th rowspan="2" class="align-bottom">Rank</th>
                <th rowspan="2" class="align-bottom">Participant</th>
                <th colspan="{{ metrics_info|length }}"
                    class="text-center bg-base-300 rounded-t-lg text-base-content/70 font-semibold uppercase text-xs tracking-wider">
                    Public Scores</th>
                {% if show_private %}
                <th colspan="{{ metrics_info|length }}"
                    class="text-center bg-secondary/20 rounded-t-lg text-secondary font-semibold uppercase text-xs tracking-wider">
                    Private Scores</th>
                {% endif %}
                <th rowspan="2" class="align-bottom">Submissions</th>
                <th rowspan="2" class="align-bottom">Last Submission</th>
            </tr>
            <tr>
                {% for _, display_name in metrics_info %}
                <th class="bg-base-300/30 text-base-content/60">{{ display_name }}</th>
                {% endfor %}
                {% if show_private %}
                {% for _, display_name in metrics_info %}
                <th class="bg-secondary/10 text-secondary/80">{{ display_name }}</th>
                {% endfor %}
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for entry in leaderboard %}
            <tr
                class="hover:bg-base-200/50 transition-colors {% if entry.is_current_user %}bg-primary/10 font-bold{% endif %}">
                <td>
                    {% if entry.rank == 1 %}
                    <span class="badge badge-warning gap-1 border-none font-bold">
                        <i data-lucide="trophy" class="w-3 h-3"></i> 1
                    </span>
                    {% elif entry.rank == 2 %}
                    <span class="badge badge-ghost border-none font-bold bg-slate-500/50 text-slate-100">2</span>
                    {% elif entry.rank == 3 %}
                    <span class="badge border-none font-bold bg-amber-700/50 text-amber-100">3</span>
                    {% else %}
                    <span class="text-base-content/50">{{ entry.rank }}</span>
                    {% endif %}
                </td>
                <td>
                    <div class="flex items-center gap-2">
                        <span class="{% if entry.is_current_user %}text-primary{% endif %}">{{ entry.username }}</span>
                        {% if entry.is_current_user %}
                        <div class="badge badge-primary badge-outline badge-sm">Me</div>
                        {% endif %}
                    </div>
                </td>
                {% for score in entry.public_display_scores %}
                <td class="bg-base-300/5">
                    <span
                        class="{% if forloop.first %}font-mono text-lg text-base-content{% else %}font-mono text-base-content/70{% endif %}">
                        {{ score|floatformat:4|default:"-" }}
                    </span>
                </td>
                {% endfor %}
                {% if show_private %}
                {% for score in entry.private_display_scores %}
                <td class="bg-secondary/5">
                    <span
                        class="{% if forloop.first %}font-mono text-lg text-secondary{% else %}font-mono text-secondary/70{% endif %}">
                        {{ score|floatformat:4|default:"-" }}
                    </span>
                </td>
                {% endfor %}
                {% endif %}
                <td class="text-base-content/70">{{ entry.submission_count }}</td>
                <td class="text-base-content/60 text-sm">{{ entry.last_submission|date:"m/d H:i" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if not show_private %}
<div class="alert alert-info mt-4">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <span>Currently showing Public Score. Private Score final rankings will be revealed after the competition
        ends.</span>
</div>
{% endif %}

<!-- Chart.js initialization -->
<script>
    (function () {
        // Destroy existing charts if they exist (for HTMX re-renders)
        if (window.trendChartInstance) {
            window.trendChartInstance.destroy();
        }
        if (window.distributionChartInstance) {
            window.distributionChartInstance.destroy();
        }

        // Fetch chart data
        fetch('{{ request.path }}chart-data/')
            .then(response => response.json())
            .then(data => {
                // Score Trend Line Chart
                const trendCtx = document.getElementById('trendChart');
                if (trendCtx && data.trend.datasets.length > 0) {
                    window.trendChartInstance = new Chart(trendCtx, {
                        type: 'line',
                        data: {
                            datasets: data.trend.datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        displayFormats: {
                                            hour: 'MM/dd HH:mm',
                                            day: 'MM/dd'
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'Time'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Score'
                                    },
                                    beginAtZero: false
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                } else if (trendCtx) {
                    trendCtx.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-slate-400">No trend data available</div>';
                }

                // Score Distribution Bar Chart
                const distCtx = document.getElementById('distributionChart');
                if (distCtx && data.distribution.labels.length > 0) {
                    window.distributionChartInstance = new Chart(distCtx, {
                        type: 'bar',
                        data: {
                            labels: data.distribution.labels,
                            datasets: [{
                                label: 'Participants',
                                data: data.distribution.data,
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: 'rgb(59, 130, 246)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    },
                                    title: {
                                        display: true,
                                        text: 'Count'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Score Range'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                } else if (distCtx) {
                    distCtx.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-slate-400">No distribution data available</div>';
                }
            })
            .catch(err => {
                console.error('Failed to load chart data:', err);
            });
    })();
</script>

{% else %}
<div class="text-center py-8 text-slate-400">
    No leaderboard data available
</div>
{% endif %}