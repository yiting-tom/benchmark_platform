<!-- HTMX partial: Leaderboard with charts -->
{% if leaderboard %}

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Score Trend Chart -->
    <div class="bg-base-200 rounded-box p-4">
        <h3 class="font-semibold mb-3 flex items-center gap-2">
            ğŸ“ˆ åˆ†æ•¸è¶¨å‹¢
        </h3>
        <div class="h-64">
            <canvas id="trendChart"></canvas>
        </div>
    </div>

    <!-- Score Distribution Chart -->
    <div class="bg-base-200 rounded-box p-4">
        <h3 class="font-semibold mb-3 flex items-center gap-2">
            ğŸ“Š åˆ†æ•¸åˆ†å¸ƒ
        </h3>
        <div class="h-64">
            <canvas id="distributionChart"></canvas>
        </div>
    </div>
</div>

<!-- Leaderboard Table -->
<div class="overflow-x-auto">
    <table class="table">
        <thead>
            <tr>
                <th>æ’å</th>
                <th>åƒè³½è€…</th>
                <th>åˆ†æ•¸</th>
                <th>æäº¤æ•¸</th>
                <th>æœ€å¾Œæäº¤</th>
            </tr>
        </thead>
        <tbody>
            {% for entry in leaderboard %}
            <tr class="{% if entry.is_current_user %}bg-primary/10 font-bold{% endif %}">
                <td>
                    {% if entry.rank == 1 %}
                    ğŸ¥‡
                    {% elif entry.rank == 2 %}
                    ğŸ¥ˆ
                    {% elif entry.rank == 3 %}
                    ğŸ¥‰
                    {% else %}
                    {{ entry.rank }}
                    {% endif %}
                </td>
                <td>
                    {{ entry.username }}
                    {% if entry.is_current_user %}
                    <span class="badge badge-sm badge-primary ml-1">æˆ‘</span>
                    {% endif %}
                </td>
                <td>
                    <span class="font-mono text-lg">{{ entry.score|floatformat:4 }}</span>
                </td>
                <td>{{ entry.submission_count }}</td>
                <td>{{ entry.last_submission|date:"m/d H:i" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if not show_private %}
<div class="alert alert-info mt-4">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <span>ç›®å‰é¡¯ç¤º Public Scoreã€‚ç«¶è³½çµæŸå¾Œå°‡å…¬å¸ƒ Private Score æœ€çµ‚æ’åã€‚</span>
</div>
{% endif %}

<!-- Chart.js initialization -->
<script>
    (function () {
        // Destroy existing charts if they exist (for HTMX re-renders)
        if (window.trendChartInstance) {
            window.trendChartInstance.destroy();
        }
        if (window.distributionChartInstance) {
            window.distributionChartInstance.destroy();
        }

        // Fetch chart data
        fetch('{{ request.path }}chart-data/')
            .then(response => response.json())
            .then(data => {
                // Score Trend Line Chart
                const trendCtx = document.getElementById('trendChart');
                if (trendCtx && data.trend.datasets.length > 0) {
                    window.trendChartInstance = new Chart(trendCtx, {
                        type: 'line',
                        data: {
                            datasets: data.trend.datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        displayFormats: {
                                            hour: 'MM/dd HH:mm',
                                            day: 'MM/dd'
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: 'æ™‚é–“'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'åˆ†æ•¸'
                                    },
                                    beginAtZero: false
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                } else if (trendCtx) {
                    trendCtx.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">å°šç„¡è¶¨å‹¢è³‡æ–™</div>';
                }

                // Score Distribution Bar Chart
                const distCtx = document.getElementById('distributionChart');
                if (distCtx && data.distribution.labels.length > 0) {
                    window.distributionChartInstance = new Chart(distCtx, {
                        type: 'bar',
                        data: {
                            labels: data.distribution.labels,
                            datasets: [{
                                label: 'åƒè³½è€…æ•¸',
                                data: data.distribution.data,
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: 'rgb(59, 130, 246)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    },
                                    title: {
                                        display: true,
                                        text: 'äººæ•¸'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'åˆ†æ•¸å€é–“'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                } else if (distCtx) {
                    distCtx.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">å°šç„¡åˆ†å¸ƒè³‡æ–™</div>';
                }
            })
            .catch(err => {
                console.error('Failed to load chart data:', err);
            });
    })();
</script>

{% else %}
<div class="text-center py-8 text-gray-500">
    å°šç„¡æ’è¡Œæ¦œè³‡æ–™
</div>
{% endif %}